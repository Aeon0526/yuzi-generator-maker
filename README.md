> 柚子代码生成器协作平台 
> 作者：孙浩

# 项目简介
深入业务场景的企业级硬项目，基于 React + Spring Boot + Picocli + 对象存储的 **代码生成器共享平台** 。

开发者可以在平台上制作并发布代码生成器，用户可以搜索、下载、在线使用代码生成器，管理员可以集中管理所有用户和生成器。
# 使用技术
#### 后端
- Java Spring Boot 开发框架（万用后端模板）
- MySQL 数据库
- MyBatis-Plus 及 MyBatis X 自动生成
- Maven 自动打包
- ⭐️ Picocli Java 命令行应用开发
- ⭐️ FreeMarker 模板引擎
- ⭐️ Caffeine + Redis 多级缓存
- ⭐️ XXL-JOB 分布式任务调度系统
- ⭐️ 腾讯云 COS 对象存储
- ⭐️ 多种设计模式
    - 命令模式
    - 模板方法模式
    - 双检锁单例模式
- ⭐️ 多角度项目优化
    - 可移植性、健壮性、可扩展性、圈复杂度优化
    - 7 种性能优化思路和实践
    - 7 种存储优化思路和实践
- ⭐️ Vert.x 响应式编程
- ⭐️ JMeter 压力测试
- Hutool 工具库和 Lambda 表达式编程

#### 项目上线

- 轻量应用服务器
- 宝塔 Linux 面板
- Nginx 反向代理
# 实现思路
本地代码生成器：能接受用户传入的参数，动态生成代码文件。
> 1. 采用**动静分离**策略，基于 FreeMarker 实现动态代码生成，使用 Hutool FileUtil 递归复制静态文件，提高了整体生成性能。（时间较多的同学可以验证下全用 FreeMarker 的性能）  
> 2. 基于**Picocli**框架，将代码生成功能封装为命令行程序，用户可以交互式地输入生成代码所需的参数，并且封装程序为 Shell 脚本，进一步简化调用。  
> 3. 基于**命令模式**实现代码生成、列举文件、查看配置等多个子命令，每个命令互不影响，使系统更易于扩展。  
  
生成器制作工具：开发者只需提供模板文件和制作配置，就能快速制作可执行的代码生成器。  
> 1. 通过**元信息设计**来规范代码生成器的信息（比如要生成的文件和传入数据），可以通过 JSON 配置修改元信息，驱动生成器的制作。  
> 2. 基于**双检锁单例模式**实现了元信息读取类，仅执行一次将元信息 JSON 转为对象的流程，防止重复实例化。  
> 3. 使用**Java Process**类动态调用 Maven 命令，将生成的代码制作为可执行 Jar 包，并通过 BufferedReader 获取命令执行结果。  
> 4. 在元信息的文件配置中，使用相对路径寻址，使得制作工具具备可移植性，可复制到其他机器运行。  
> 5. 由于元信息配置较为复杂，编写元信息校验类，集中校验元信息并填充默认值，提高了程序的健壮性。  
> 6. 由于元信息的校验逻辑复杂、代码分支多，使用 MetricsReloaded 插件检测圈复杂度，并通过卫语句、封装方法、语法糖等方式将平均 圈复杂度由 62 降低到 7.5。  
> 7. 由于生成器制作流程较多、代码复杂，使用 模板方法模式，将主流程定义为抽象模板，通过子类重写各个具体的生成环节，使系统更易于维护扩展。  
  
模板制作工具：能够快速对静态文件 “挖坑”，生成 FTL 模板和元信息配置，提高生成器制作效率。  
> 1. 采用 工作空间 机制，制作模板时通过 雪花算法 生成唯一目录，保证不污染原项目文件、每次制作互不影响  
> 2. 设计文件过滤机制，支持通过配置的方式从目录中筛选指定的文件进行制作，比如按正则匹配文件内容。  
> 3. 有状态化：通过给每次模板制作生成唯一 id，实现分步制作、追加配置的能力，并通过 Stream API 实现配置的去重。  
  
web 平台：提供生成器在线制作、发布、使用、下载能力。  
> 1. 库表设计：由于生成器的文件配置复杂，使用 JSON 对象代替多列存储，使字段更利于扩展  
> 2. 基于自己二次开发的 Spring Boot 初始化模板 + MyBatis X 插件，快速生成用户、生成器的增删改查代码。  
> 3. 自主封装可复用的 COS 对象存储操作类，可通过 Config 类读取配置并生成实例，实现了生成器文件的上传下载。  
> 4. 由于下载生成器较慢，通过服务端缓存已下载文件，减少从对象存储拉取文件的耗时。对于大文件，实测下载时长可缩短 100 倍。  
> 5. 为减少查询生成器接口的响应时长，优化 SQL，仅查询前端必要的数据，实测响应时长减少了 1/3。  
> 6. 为优化查询生成器接口的性能，使用 JMeter 配置线程组进行压测，通过响应断言和聚合报告获取压测结果。  
> 7. 为优化查询生成器接口的性能，基于 Redis + Caffeine 实现多级缓存，兼具持久化和高性能，并编写了通用的多级缓存操作类。相比直查 DB，响应时长缩短了 80%、qps 提升了 3 倍。  
> 8. 为进一步优化性能，对于缓存操作采用 JDK 默认序列化替代 JSON 序列化，减少 CPU 计算，实测 qps 提升了 5 倍。  
> 9. 请求层性能优化：通过调整 tomcat 最大线程数配置，将 qps 提升了 1 倍；并尝试通过 Vert.x 反应式编程框架替代 tomcat 接受请求。  
> 10. 为防止文件存储超限，设计了每日定时的文件清理机制，并通过 XXL-JOB 解决了分布式任务冲突，节约了 10% 的存储空间。  
> 11. 针对生成器发布后访问频率持续降低的情况，设计了 数据沉降机制，将发布 30 天后的生成器文件转储到更便宜的低频存储，节约 34% 的成本。（这个值是根据官方文档的经验值估算的）  
> 12. 为保证存储安全，对 COS 配置了防盗链；并基于 最小权限原则，先将存储桶访问权限设置为私有读写，再配置 Policy 白名单允许访问生成器图片。  
> 13. 使用宝塔 Linux，通过运行 Jar 包快速部署后端；并通过 Nginx 反向代理，将请求转发到后端，防止跨域。
